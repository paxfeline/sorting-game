<html>
    <head>
        <style>

.dropitem
{
    width: 3em;
    height: 3em;
    background-color: pink;
    position: absolute;
}

.dropzone
{
    width: 10em;
    height: 10em;
    position: relative;
}

.dropzone-active
{
    outline: 0.3em solid rgba(255, 100, 100, 0.5);
}

        </style>
        <script>
            
            builder_globals = {};

 // TODO: in this handler, set the value attribute explicitly so that it's copied
 function dragstart_move_handler(ev)
{
	console.log(ev);
	
	//ev.target.firstElementChild.innerHTML = ev.target.firstElementChild.value;
	ev.dataTransfer.setData("application/hexfield-element", ev.target.outerHTML);
	ev.dataTransfer.dropEffect = "move";
	builder_globals.dragged = ev.target;
    builder_globals.offset = {x: ev.offsetX, y: ev.offsetY};

    console.log(ev.offsetX, ev.offsetY);
	
	ev.stopPropagation();
}

function onDragLeave(event)
{
    //console.log(event.target);

	event.target.classList.remove("dropzone-active");
}


function drop_handler(ev) {
// if (!drop_ok(ev)) return;
 ev.preventDefault();
 // Get the id of the target and add the moved element to the target's DOM
 const data = ev.dataTransfer.getData("application/hexfield-element");
 //ev.target.style.backgroundColor = '';
 const temp = document.createElement("div");


	 temp.innerHTML = data;

    temp.firstElementChild.style.left = `${ev.clientX - ev.target.offsetLeft - builder_globals.offset.x}px`;
    temp.firstElementChild.style.top = `${ev.clientY - ev.target.offsetTop - builder_globals.offset.y}px`;
 
	ev.target.append( temp.firstElementChild );


    ev.target.classList.remove("dropzone-active");
	  
    builder_globals.dragged.remove();



    console.log(ev);
    console.log(ev.pageX - ev.target.offsetLeft - builder_globals.offset.x, ev.pageY - ev.target.offsetTop - builder_globals.offset.y);
}


function dragover_handler(ev)
{
	//console.log('doh', ev);
	
	if (ev.dataTransfer.getData("application/hexfield-element"))
		//&& drop_ok(ev))
	{
        ev.preventDefault();
	}
}

function dragenter_handler(ev)
{
	//console.log('doh', ev);
	
	if (ev.target.classList.contains("dropzone") && ev.dataTransfer.getData("application/hexfield-element"))
		//&& drop_ok(ev))
	{
        ev.dataTransfer.dropEffect = "move";
			
		ev.target.classList.add("dropzone-active");
        //console.log("active", ev.target);
        ev.preventDefault();
	}
}

        </script>
    </head>

    <body>

        <div class="dropzone" ondragleave="onDragLeave(event)" ondrop="drop_handler(event)" ondragover="dragover_handler(event)" ondragenter="dragenter_handler(event)">
            <div class="dropitem" draggable="true" ondragstart="dragstart_move_handler(event)">
            </div>
        </div>
        
        <div class="dropzone" ondragleave="onDragLeave(event)" ondrop="drop_handler(event)" ondragover="dragover_handler(event)" ondragenter="dragenter_handler(event)">
        </div>

    </body>

</html>
