<html>
    <head>
        <style>

#game
{
    touch-action: none;
}

.dropitem
{
    width: 3em;
    height: 3em;
    background-color: pink;
    position: absolute;
    border-radius: 50%;
}

.dropzone
{
    width: 20em;
    height: 20em;
    position: relative;
    margin: 1em;
    display: inline-block;
}

#main
{
    width: 40em;
}

.dropzone-active
{
    outline: 0.3em solid rgba(255, 100, 100, 0.5);
}

/*
.dragitem-dragging
{
    opacity: 0.5;
}
*/

        </style>
    </head>

    <body>

        <div id="game">
            <div>
            
                <div class="dropzone" data-role="dropzone" ondragleave="onDragLeave(event)" ondrop="drop_handler(event)" ondragover="dragover_handler(event)" ondragenter="dragenter_handler(event)">
                </div>
                
                <div class="dropzone" data-role="dropzone" ondragleave="onDragLeave(event)" ondrop="drop_handler(event)" ondragover="dragover_handler(event)" ondragenter="dragenter_handler(event)">
                </div>
    
            </div> 

            <div id="main" class="dropzone" data-role="dropzone" ondragleave="onDragLeave(event)" ondrop="drop_handler(event)" ondragover="dragover_handler(event)" ondragenter="dragenter_handler(event)">
                <div id="first" class="dropitem"  data-role="dragitem" draggable="true" ondragstart="dragstart_move_handler(event)">
                </div>
            </div>

            <div>
            
                <div class="dropzone" data-role="dropzone" ondragleave="onDragLeave(event)" ondrop="drop_handler(event)" ondragover="dragover_handler(event)" ondragenter="dragenter_handler(event)">
                </div>
                
                <div class="dropzone" data-role="dropzone" ondragleave="onDragLeave(event)" ondrop="drop_handler(event)" ondragover="dragover_handler(event)" ondragenter="dragenter_handler(event)">
                </div>

            </div>

        </div>

        <script>

let game = document.querySelector("#game");

let gameState = {};

game.addEventListener("pointerdown",
    e =>
    {
        console.log("pd", e);

        let role = e.target.dataset.role;

        if (role == "dragitem")
        {
            e.preventDefault();
            game.setPointerCapture(e.pointerId);
            // move to top / end of parent
            e.target.parentElement.append(e.target);
            //gameState.original = e.target;
            gameState.dragging = e.target; //.cloneNode();
            //main.append(gameState.dragging);
            //gameState.dragging.classList.add("dragitem-dragging");
            gameState.offset = {x: e.offsetX, y: e.offsetY};
            gameState.start = {x: e.pageX, y: e.pageY};
        }
    }
);

game.addEventListener("pointermove",
    e =>
    {
        if (!gameState.dragging) return;

        console.log("pm", e.target.dataset.role, e);

        let hits = document.elementsFromPoint(e.clientX, e.clientY);

        let hit;
        while ( hit = hits.pop() )
        {
            if (hit.dataset.role == "dropzone")
            {
                console.log("hit", hit);
                hit.classList.add("dropzone-active");
                break;
            }
        }

        let t = gameState.dragging;

        console.log(`${Number(t.dataset.x) + (e.pageX - gameState.start.x)}px\n${Number(t.dataset.y) + (e.pageY - gameState.start.y)}px`);

        t.style.left = `${Number(t.dataset.x) + (e.pageX - gameState.start.x)}px`;
        t.style.top = `${Number(t.dataset.y) + (e.pageY - gameState.start.y)}px`;
    }
);

function getTop(elem)
{
    let rect = elem.getBoundingClientRect();
    return rect.top + window.scrollY;
}

function getLeft(elem)
{
    let rect = elem.getBoundingClientRect();
    return rect.left + window.scrollX;
}

game.addEventListener("pointerup",
    e =>
    {
        console.log("pu", e.target.dataset.role, e);

        game.releasePointerCapture(e.pointerId);

        //let role = e.target.dataset.role;

        let hits = document.elementsFromPoint(e.clientX, e.clientY);

        console.log(hits);

        let hit;
        while ( hit = hits.pop() )
        {
            if (hit.dataset.role == "dropzone")
            {
                console.log("hit", hit);
                break;
            }
        }

        let t = gameState.dragging;
        let d = hit;

        if (!t || !d) return;

        gameState.dragging = null;

        debugger;

        //let x = t.offsetLeft - d.offsetLeft;
        //let y = t.offsetTop - d.offsetTop;

        let x = getLeft(t) - d.offsetLeft;
        let y = getTop(t) - d.offsetTop;

        console.log(Number(t.dataset.y) + (e.pageY - gameState.start.y));

        t.dataset.x = x;
        t.dataset.y = y;

        t.style.left = `${x}px`;
        t.style.top = `${y}px`;

        d.append(t);

        d.classList.remove("dropzone-active");
    }
);

/*

builder_globals = {};
let touchTarget;

 // TODO: in this handler, set the value attribute explicitly so that it's copied
 function dragstart_move_handler(ev)
{
	console.log(ev);
	
	//ev.target.firstElementChild.innerHTML = ev.target.firstElementChild.value;
	builder_globals.data = ev.target.outerHTML;
	builder_globals.dragged = ev.target;
    builder_globals.offset = {x: ev.offsetX, y: ev.offsetY};

    console.log(ev.offsetX, ev.offsetY);
	
	ev.stopPropagation();
}

function onDragLeave(event)
{
    console.log(event);
    let found = getDropzone(event);
    //if (event.target == found)
        //found.classList.remove("dropzone-active");
 event.preventDefault();
}


function drop_handler(ev) {
// if (!drop_ok(ev)) return;
 ev.preventDefault();
 // Get the id of the target and add the moved element to the target's DOM
 const data = builder_globals.data;
 //ev.target.style.backgroundColor = '';
 const temp = document.createElement("div");


	 temp.innerHTML = data;


     let found = getDropzone(ev);

    temp.firstElementChild.style.left = `${ev.clientX - found.offsetLeft - builder_globals.offset.x}px`;
    temp.firstElementChild.style.top = `${ev.clientY - found.offsetTop - builder_globals.offset.y}px`;
 
	found.append( temp.firstElementChild );

    found.classList.remove("dropzone-active");
	  
    builder_globals.dragged.remove();



    console.log(ev);
    console.log(ev.pageX - ev.target.offsetLeft - builder_globals.offset.x, ev.pageY - ev.target.offsetTop - builder_globals.offset.y);
}

function dragover_handler(ev)
{
	console.log('doh', ev);
	
    let found = getDropzone(ev);
    
	if (builder_globals.dragged)
	{

        ev.preventDefault();
	}
}

function getDropzone(ev)
{
    if (ev.target.classList.contains("dropzone"))
        return ev.target;
    else if (ev.target.parentElement.classList.contains("dropzone"))
        return ev.target.parentElement;
}

function dragenter_handler(ev)
{
	console.log('deh', ev);

    let found = getDropzone(ev);
	
	if (found && builder_globals.dragged)
		//&& drop_ok(ev))
	{
        ev.dataTransfer.dropEffect = "move";
			
		found.classList.add("dropzone-active");
        //console.log("active", ev.target);

        ev.preventDefault();
	}
}

function addTouchEvents()
{
    let items = document.querySelectorAll(".dropitem");
    items.forEach(
        el =>
        {
            console.log(el);
            el.addEventListener("touchstart",
                e =>
                {
                    console.log("ts", e);
                    let de = new DragEvent("dragstart", {options: e.targetTouches[0]});
                    el.dispatchEvent(de);
                }
            );
            el.addEventListener("touchmove",
                e =>
                {
                    console.log("tm-1", e);
                    let de = new DragEvent("drag", {options: e.targetTouches[0]});
                    el.dispatchEvent(de);
                }
            );
            el.addEventListener("touchend",
                e =>
                {
                    console.log("te-1", e);
                    let de = new DragEvent("dragend", {options: e.targetTouches[0]});
                    el.dispatchEvent(de);
                }
            );
        }
    )

    document.body.addEventListener("touchmove",
        e =>
        {
            console.log("tm", e);
            if (e.target != touchTarget)
            {
                if (touchTarget)
                {
                    let de = new DragEvent("dragleave", {options: e.targetTouches[0]});
                    touchTarget.dispatchEvent(de);
                }
                touchTarget = e.target;
                let de = new DragEvent("dragenter", {options: e.targetTouches[0]});
                touchTarget.dispatchEvent(de);
            }
            else if (touchTarget)
            {
                let de = new DragEvent("dragover", {options: e.targetTouches[0]});
                touchTarget.dispatchEvent(de);
            }
        }
    );

    document.body.addEventListener("touchend",
        e =>
        {
            console.log("te", e);
            if (touchTarget)
            {
                let de = new DragEvent("drop", {options: e.targetTouches[0]});
                touchTarget.dispatchEvent(de);
                touchTarget = null;
            }
        }
    );

    let zones = document.querySelectorAll(".dropzone");
    zones.forEach(
        el =>
        {
            console.log(el);
            el.addEventListener("touchmove",
                e =>
                {
                }
            )
        }
    );
}

*/

function scatter()
{
    let main = document.querySelector("#main");
    let first = document.querySelector("#first");

    for ( let i = 0; i < 5; i++ )
    {
        let item = first.cloneNode(false);
        let h = Math.random() * 360;
        item.style.backgroundColor = `hsl(${h}deg, 100%, 75%)`;
        let x = Math.random() * (main.offsetWidth - main.offsetWidth * 0.075); // 40em - 3em
        let y = Math.random() * (main.offsetHeight - main.offsetHeight * 0.15); // 20em - 3em
        item.dataset.x = x;
        item.dataset.y = y;
        item.style.left = `${x}px`;
        item.style.top = `${y}px`;
        item.removeAttribute("id");
        main.append(item);
    }

    first.remove();
}

scatter();

        </script>

    </body>
</html>
